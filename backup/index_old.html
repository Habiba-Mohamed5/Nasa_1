<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>رحلة كوكبنا — تفاعلي</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="" crossorigin=""/>
  <!-- Google Cairo font -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0f172a;
      --card: rgba(255,255,255,0.06);
      --accent1:#0ea5e9;
      --accent2:#059669;
      --accent3:#ea580c;
      --muted: #cbd5e1;
      --glass: rgba(255,255,255,0.04);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(180deg,var(--bg) 0%, #09203f 100%);
      color: white;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow-y:auto;
    }

    /* Layout */
    .container{max-width:1200px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px}
    .logo{display:flex;align-items:center;gap:12px}
    .logo .dot{width:46px;height:46px;border-radius:50%;background:conic-gradient(var(--accent2),var(--accent1),var(--accent3));box-shadow:0 6px 18px rgba(0,0,0,0.6)}
    h1{font-size:1.4rem;margin:0}
    p.lead{color:var(--muted);margin-top:6px;font-size:0.95rem}

    /* Landing */
    .hero{
      margin-top:18px;
      display:grid;
      grid-template-columns: 1fr 420px;
      gap:24px;
      align-items:center;
    }
    .hero-card{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding:28px;border-radius:16px;backdrop-filter: blur(6px);
      box-shadow: 0 10px 30px rgba(2,6,23,0.6);
    }
    .cta{
      display:inline-flex;gap:12px;align-items:center;padding:12px 20px;border-radius:999px;border:none;
      background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#001; font-weight:700; cursor:pointer;
      transform:translateY(0); transition:all .25s ease;
    }
    .cta:hover{transform:translateY(-6px); box-shadow:0 18px 50px rgba(10,20,40,0.6)}

    /* Right panel: globe-preview & small controls */
    .preview{
      background:var(--card); padding:18px;border-radius:14px; text-align:center;
      min-height:320px; display:flex;flex-direction:column;gap:12px; align-items:center; justify-content:center;
    }
    .preview .mini-map{width:100%;height:260px;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.04)}
    .icons{display:flex;gap:10px;justify-content:center;margin-top:6px}
    .tag{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);font-weight:600}

    /* Main interactive area */
    .explorer{display:none;margin-top:24px;gap:18px}
    .explorer.active{display:block}

    .top-row{display:grid;grid-template-columns:1fr 400px;gap:18px}
    .panel{background:var(--card);padding:18px;border-radius:14px;min-height:220px;box-shadow:0 8px 30px rgba(2,6,23,0.5)}
    #map{height:420px;border-radius:10px}
    .controls{display:flex;flex-direction:column;gap:12px}
    .datasets{display:flex;gap:8px;flex-wrap:wrap}
    .dataset-btn{cursor:pointer;padding:8px 12px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.06);font-weight:700}
    .dataset-btn.active{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#001;border-color:transparent;box-shadow:0 10px 30px rgba(0,0,0,0.5)}

    /* Animation viewer */
    .viewer{position:relative;height:260px;border-radius:10px;overflow:hidden;background:#000}
    .viewer .frame{
      width:100%;height:100%;background-size:cover;background-position:center;transition:background-image .45s ease;
      display:flex;align-items:flex-end;justify-content:center;padding:12px;
    }
    .viewer .caption{background:linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.6));padding:8px 12px;border-radius:8px;font-weight:700}

    .player{display:flex;align-items:center;gap:10px;justify-content:center;margin-top:8px}
    .play-btn{padding:8px 12px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent2),var(--accent3));cursor:pointer;font-weight:700}
    .small{padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);cursor:pointer}

    /* Slider */
    .timeline{display:flex;align-items:center;gap:12px;margin-top:12px}
    .timeline input[type="range"]{width:100%}

    /* Chart area */
    .chart-wrap{height:220px}

    /* Story overlay */
    .story-overlay{position:relative;margin-top:12px;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(0,0,0,0.02), rgba(255,255,255,0.02));min-height:60px}
    .story-overlay p{margin:0;color:var(--muted)}

    /* Quiz */
    .quiz{margin-top:18px;padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))}
    .quiz h3{margin:0 0 8px 0}
    .choices{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .choice{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);cursor:pointer;border:1px solid rgba(255,255,255,0.04);font-weight:600}
    .choice.correct{background:linear-gradient(90deg,#a7f3d0,#4ade80);color:#062c1a}
    .choice.wrong{background:linear-gradient(90deg,#fecaca,#f87171);color:#3a0505}
    .feedback{margin-top:8px;color:var(--muted)}

    footer{margin:40px 0;text-align:center;color:var(--muted)}
    /* Responsive */
    @media (max-width:1000px){
      .hero{grid-template-columns:1fr}
      .top-row{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <div class="dot" aria-hidden></div>
        <div>
          <h1>رحلة كوكبنا عبر بيانات Terra</h1>
          <p class="lead">تجربة تفاعلية — استكشفي تغير الأرض سنة بسنة</p>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:12px">
        <button id="btnBackToHero" class="small" title="رجوع">العودة للواجهة</button>
        <a class="small" href="#" id="credits">مصادر: NASA • MODIS</a>
      </div>
    </header>

    <!-- Landing -->
    <section class="hero">
      <div class="hero-card">
        <h2 style="margin-bottom:8px">مرحبًا — تجربة تفاعلية لبيانات Terra</h2>
        <p class="lead">شغّلي الخريطة، حرّكي الشريط الزمني، واكتشفي كيف تغيّر الغطاء النباتي والجليد والتلوث عبر العقدين الماضيين. يوجد أيضًا اختبار سريع لقياس الفهم.</p>
        <div style="margin-top:18px;display:flex;gap:12px;flex-wrap:wrap">
          <button id="startBtn" class="cta">ابدأ الاستكشاف</button>
          <button id="demoPlay" class="small">تشغيل مثال تلقائي</button>
          <button id="openQuiz" class="small">اذهب للاختبار</button>
        </div>

        <div style="margin-top:20px;display:flex;gap:12px;align-items:center;flex-wrap:wrap">
          <div class="tag">🌳 غابات</div>
          <div class="tag">❄️ جليد</div>
          <div class="tag">🏭 تلوث</div>
        </div>

        <div style="margin-top:18px">
          <strong>ملاحظة:</strong> كل البيانات داخل هذا العرض هي **نماذج تجريبية (mock)** لتشغيل الواجهة؛ إذا حبيتي أوصّللك ربط البيانات الحقيقية من NASA أقدملك نسخة ثنائية مع API/pipeline.
        </div>
      </div>

      <aside class="preview">
        <div style="font-weight:800">معاينة الخريطة التفاعلية</div>
        <div id="miniMap" class="mini-map"></div>
        <div class="icons">
          <div class="tag">Live Preview</div>
          <div class="tag">2D Globe</div>
        </div>
      </aside>
    </section>

    <!-- Explorer (main interactive) -->
    <section class="explorer" id="explorer">
      <div class="top-row">
        <!-- Left: Map -->
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <div style="font-weight:800">الخريطة التفاعلية</div>
            <div style="display:flex;gap:8px;align-items:center">
              <select id="regionSelect" style="background:transparent;color:white;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04)">
                <option value="world">كل الكرة</option>
                <option value="amazon">الأمازون</option>
                <option value="arctic">القطب الشمالي</option>
                <option value="africa">إفريقيا</option>
              </select>
            </div>
          </div>
          <div id="map"></div>
          <div style="margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <div class="datasets" id="datasets">
              <button class="dataset-btn active" data-dataset="vegetation">🌳 نبات</button>
              <button class="dataset-btn" data-dataset="ice">❄️ جليد</button>
              <button class="dataset-btn" data-dataset="pollution">🏭 تلوث</button>
            </div>
            <div style="margin-left:auto;color:var(--muted);font-size:0.9rem">السنة: <span id="mapYear">2010</span></div>
          </div>
        </div>

        <!-- Right: Viewer + chart -->
        <div>
          <div class="panel">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:800">عارض الأنيميشن</div>
              <div style="display:flex;gap:8px">
                <button id="playPause" class="play-btn">▶ تشغيل</button>
                <button id="stepBack" class="small">«</button>
                <button id="stepForward" class="small">»</button>
              </div>
            </div>

            <div class="viewer" id="viewer">
              <div class="frame" id="frame">
                <div class="caption" id="frameCaption">اختر نوع الداتا والسنة لبدء العرض</div>
              </div>
            </div>

            <div class="player">
              <div style="width:100%">
                <div class="timeline">
                  <span style="min-width:48px;text-align:center">2000</span>
                  <input type="range" id="yearSlider" min="2000" max="2023" value="2010" step="1">
                  <span style="min-width:48px;text-align:center">2023</span>
                </div>
              </div>
            </div>

            <div class="story-overlay" id="storyOverlay"><p id="storyText">نص سردي يظهر مع تغيير السنة — جرّبي السلايدر</p></div>
          </div>

          <div class="panel" style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div style="font-weight:800">المؤشرات الزمنية</div>
              <div style="color:var(--muted);font-size:0.9rem">مؤشر تجريبي</div>
            </div>
            <div class="chart-wrap">
              <canvas id="lineChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Quiz & details -->
      <div style="display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:18px">
        <div class="panel">
          <h3 style="margin:0 0 8px 0">قصة مُختصرة</h3>
          <p style="color:var(--muted)">هذه القصة تعطيك لمحة عن التحولات في الغطاء النباتي، الجليد، والتلوث بين 2000 و2023. استخدمي الأدوات أعلاه لتتتبعي السنة والمنطقة.</p>

          <div style="margin-top:12px">
            <h4 style="margin:0 0 8px 0">ملاحظات تقنية</h4>
            <ul style="color:var(--muted);margin-top:6px">
              <li>الخريطة تستخدم طبقات نقاط ملونة لتمثيل المؤشرات (mock data).</li>
              <li>الصور في الـViewer هي روابط عامة (Unsplash) كـمplaceholders.</li>
              <li>يمكن ربط بيانات حقيقية لاحقًا عبر API واستخدام GeoTIFF أو XYZ tiles.</li>
            </ul>
          </div>
        </div>

        <aside class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 style="margin:0">اختبار سريع</h3>
            <div style="color:var(--muted)">3 أسئلة</div>
          </div>

          <div class="quiz" id="quizArea">
            <div id="qBox">
              <h3 id="qTitle">كم نسبة فقدان الغطاء النباتي النموذجي بين 2000 و2020؟</h3>
              <div class="choices" id="choices">
                <!-- choices injected -->
              </div>
              <div class="feedback" id="qFeedback"></div>
            </div>
            <div style="margin-top:12px;display:flex;gap:8px">
              <button id="nextQ" class="small">السؤال التالي</button>
              <button id="resetQ" class="small">إعادة الاختبار</button>
            </div>
          </div>
        </aside>
      </div>
    </section>

    <footer>حقوق التصميم © تجربتك التفاعلية — جاهز للعرض أمام لجنة التحكيم</footer>
  </div>

  <!-- External libs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

  <script>
    /*****************************************************************
     * بيانات نموذجية (mock) — ممكن تستبدليها ببيانات حقيقية لاحقًا
     *****************************************************************/
    const YEARS = Array.from({length: 24},(_,i)=>2000+i); //2000..2023

    // صور توضيحية (placeholders من Unsplash - آمنة للعرض)
    const IMAGES = {
      vegetation: {
        // mapping some example years to images (others reuse nearest)
        2000: 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=1600&q=60',
        2005: 'https://images.unsplash.com/photo-1544550285-f813152fb2fd?w=1600&q=60',
        2010: 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?w=1600&q=60',
        2015: 'https://images.unsplash.com/photo-1499346030926-9a72daac6c63?w=1600&q=60',
        2020: 'https://images.unsplash.com/photo-1559827260-dc66d52bef19?w=1600&q=60',
        2023: 'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?w=1600&q=60'
      },
      ice: {
        2000: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=1600&q=60',
        2005: 'https://images.unsplash.com/photo-1579952363873-27d3bfad9c0d?w=1600&q=60',
        2010: 'https://images.unsplash.com/photo-1482192596544-9eb780fc7f66?w=1600&q=60',
        2015: 'https://images.unsplash.com/photo-1516728778615-2d590ea1856f?w=1600&q=60',
        2020: 'https://images.unsplash.com/photo-1583212292454-1fe6229603b7?w=1600&q=60',
        2023: 'https://images.unsplash.com/photo-1549880338-65ddcdfd017b?w=1600&q=60'
      },
      pollution: {
        2000: 'https://images.unsplash.com/photo-1470813740244-df37b8c7bb3f?w=1600&q=60',
        2005: 'https://images.unsplash.com/photo-1505672678657-cc7037095e2c?w=1600&q=60',
        2010: 'https://images.unsplash.com/photo-1469474968028-56623f02e42e?w=1600&q=60',
        2015: 'https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=1600&q=60',
        2020: 'https://images.unsplash.com/photo-1581091012184-7f7b3b4f8a7d?w=1600&q=60',
        2023: 'https://images.unsplash.com/photo-1518709268805-4e9042af9f23?w=1600&q=60'
      }
    };

    // Mock numeric indicators per year (مثال: نسبة الغطاء النباتي المتبقي)
    const MOCK_VEG = YEARS.map(y => {
      // gradual decline with noise
      const base = 100 - (y - 2000) * 1.3; // about -1.3% per year
      return Math.max(20, Math.round((base + (Math.random()*6-3)) * 10)/10);
    });

    const MOCK_ICE = YEARS.map(y => {
      const base = 100 - (y - 2000) * 1.6;
      return Math.max(10, Math.round((base + (Math.random()*8-4))*10)/10);
    });

    const MOCK_POLL = YEARS.map(y => {
      const base = 40 + (y - 2000) * 0.8;
      return Math.min(100, Math.round((base + (Math.random()*6-3))*10)/10);
    });

    /*****************************************************************
     * Initialization: map, miniMap, chart
     *****************************************************************/
    // miniMap for preview (static)
    const miniMap = L.map('miniMap', {attributionControl:false, zoomControl:false, dragging:false}).setView([10,0],1);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(miniMap);

    // main map
    const map = L.map('map').setView([5, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

    // layer for data points
    const dataLayer = L.layerGroup().addTo(map);

    // simple polygon approximations for regions (very rough)
    const REGIONS = {
      world: null,
      amazon: L.polygon([[-10,-75],[-5,-60],[0,-55],[5,-60],[0,-70],[-5,-75]],{color:'#2dd4bf',weight:1,fill:false}),
      arctic: L.polygon([[70,-170],[75,-120],[80,-60],[82,0],[80,60],[75,120],[70,170]],{color:'#60a5fa',weight:1,fill:false}),
      africa: L.polygon([[37,-10],[10,10],[0,30],[-15,25],[-34,18],[-20,0],[10,-20],[30,0],[37,-10]],{color:'#f59e0b',weight:1,fill:false})
    };

    // helper to show region
    function showRegion(name){
      // clear
      Object.values(REGIONS).forEach(r => { if (r && map.hasLayer(r)) map.removeLayer(r); });
      if(REGIONS[name]) map.addLayer(REGIONS[name]);
    }

    // function to draw mock points depending on dataset & year & region
    function drawMockPoints(dataset, year, region){
      dataLayer.clearLayers();
      // generate some random points inside bounding boxes per region
      let bbox = [-85, -180, 85, 180]; // default world latMin, lonMin, latMax, lonMax
      if(region === 'amazon') bbox = [-15, -80, 5, -50];
      if(region === 'arctic') bbox = [60, -170, 85, 170];
      if(region === 'africa') bbox = [-35, -20, 37, 55];

      // count depends on dataset
      const count = 30;
      for(let i=0;i<count;i++){
        const lat = bbox[0] + Math.random()*(bbox[2]-bbox[0]);
        const lon = bbox[1] + Math.random()*(bbox[3]-bbox[1]);
        let color = '#34d399';
        let radius = 60000;
        if(dataset === 'ice'){ color = '#60a5fa'; radius = 80000; }
        if(dataset === 'pollution'){ color = '#f97316'; radius = 40000; }
        const circle = L.circle([lat,lon],{color:color,fillColor:color,fillOpacity:0.45,radius: radius});
        circle.bindTooltip(`${dataset} • ${year}`, {direction:'top'});
        dataLayer.addLayer(circle);
      }
    }

    // Chart
    const ctx = document.getElementById('lineChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: YEARS,
        datasets: [
          { label: 'Vegetation (%)', data: MOCK_VEG, borderWidth:2, tension:0.3, pointRadius:2, borderColor:'#34d399', backgroundColor:'rgba(52,211,153,0.08)'},
          { label: 'Ice (%)', data: MOCK_ICE, borderWidth:2, tension:0.3, pointRadius:2, borderColor:'#60a5fa', backgroundColor:'rgba(96,165,250,0.06)'},
          { label: 'Pollution (index)', data: MOCK_POLL, borderWidth:2, tension:0.3, pointRadius:2, borderColor:'#fb923c', backgroundColor:'rgba(251,146,60,0.06)'}
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{legend:{labels:{color:'white'}}},
        scales:{
          x:{ticks:{color:'#cbd5e1'}},
          y:{ticks:{color:'#cbd5e1'}}
        }
      }
    });

    /*****************************************************************
     * UI wiring
     *****************************************************************/
    const startBtn = document.getElementById('startBtn');
    const explorerEl = document.getElementById('explorer');
    const datasetsEls = document.querySelectorAll('.dataset-btn');
    const playPauseBtn = document.getElementById('playPause');
    const yearSlider = document.getElementById('yearSlider');
    const frame = document.getElementById('frame');
    const frameCaption = document.getElementById('frameCaption');
    const storyText = document.getElementById('storyText');
    const mapYearEl = document.getElementById('mapYear');
    const regionSelect = document.getElementById('regionSelect');
    const btnBackToHero = document.getElementById('btnBackToHero');
    const demoPlay = document.getElementById('demoPlay');

    // state
    let currentDataset = 'vegetation';
    let playing = false;
    let playInterval = null;
    let currentYear = parseInt(yearSlider.value);

    function nearestImage(dataset, year){
      // choose nearest available in IMAGES
      const keys = Object.keys(IMAGES[dataset]).map(k=>parseInt(k)).sort((a,b)=>a-b);
      let best = keys[0];
      for(let k of keys){ if(k<=year) best=k; else break; }
      return IMAGES[dataset][best];
    }

    function updateAll({skipMap=false} = {}){
      currentYear = parseInt(yearSlider.value);
      mapYearEl.textContent = currentYear;
      // update viewer frame image + caption
      const img = nearestImage(currentDataset, currentYear);
      frame.style.backgroundImage = `url('${img}')`;
      frameCaption.textContent = `${currentDataset === 'vegetation' ? 'الغطاء النباتي' : currentDataset === 'ice' ? 'الغطاء الجليدي' : 'التلوث'} — سنة ${currentYear}`;

      // update story text
      const story = getStoryText(currentDataset, currentYear, regionSelect.value);
      storyText.textContent = story;

      // update chart highlight (simple: show tooltip-like effect by updating datasets visibility)
      // we'll fade others
      chart.data.datasets.forEach(ds => {
        if((currentDataset === 'vegetation' && ds.label.startsWith('Vegetation')) ||
           (currentDataset === 'ice' && ds.label.startsWith('Ice')) ||
           (currentDataset === 'pollution' && ds.label.startsWith('Pollution'))){
             ds.borderWidth = 3; ds.pointRadius = 3; ds.backgroundColor = ds.backgroundColor;
           } else { ds.borderWidth = 1; ds.pointRadius = 0; }
      });
      chart.update();

      // update map points
      if(!skipMap) drawMockPoints(currentDataset, currentYear, regionSelect.value);
      showRegion(regionSelect.value);
    }

    // attach dataset buttons
    datasetsEls.forEach(btn => {
      btn.addEventListener('click', () => {
        datasetsEls.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        currentDataset = btn.getAttribute('data-dataset');
        updateAll();
      });
    });

    // slider actions
    yearSlider.addEventListener('input', () => {
      updateAll();
    });

    // region change
    regionSelect.addEventListener('change', () => {
      updateAll();
      // focus map to region rough bounds
      const r = regionSelect.value;
      if(r === 'amazon') map.fitBounds([[-15,-80],[5,-50]]);
      else if(r === 'arctic') map.setView([78, 0], 2.2);
      else if(r === 'africa') map.fitBounds([[-35,-20],[37,55]]);
      else map.setView([5,0],2);
    });

    // play/pause
    playPauseBtn.addEventListener('click', () => {
      if(!playing){
        playPause();
      } else {
        stopPlay();
      }
    });

    function playPause(){
      playing = true;
      playPauseBtn.textContent = '⏸ إيقاف';
      playInterval = setInterval(()=>{
        let v = parseInt(yearSlider.value);
        v++;
        if(v>parseInt(yearSlider.max)){ v = parseInt(yearSlider.min); }
        yearSlider.value = v;
        updateAll();
      }, 900);
    }
    function stopPlay(){
      playing = false;
      playPauseBtn.textContent = '▶ تشغيل';
      clearInterval(playInterval);
    }

    document.getElementById('stepBack').addEventListener('click', () => {
      let v = parseInt(yearSlider.value) - 1;
      if(v < parseInt(yearSlider.min)) v = parseInt(yearSlider.max);
      yearSlider.value = v; updateAll();
    });
    document.getElementById('stepForward').addEventListener('click', () => {
      let v = parseInt(yearSlider.value) + 1;
      if(v > parseInt(yearSlider.max)) v = parseInt(yearSlider.min);
      yearSlider.value = v; updateAll();
    });

    // start button to reveal explorer
    startBtn.addEventListener('click', () => {
      explorerEl.classList.add('active');
      // animate transition with GSAP
      gsap.fromTo('.explorer.active',{opacity:0,y:30},{duration:0.9,opacity:1,y:0});
      // initial update
      updateAll();
      // center map
      map.invalidateSize();
    });

    btnBackToHero.addEventListener('click', () => {
      explorerEl.classList.remove('active');
      gsap.to(window, {duration: 0.7, scrollTo:0});
    });

    // demo play: auto open explorer and play briefly
    demoPlay.addEventListener('click', () => {
      startBtn.click();
      setTimeout(()=>{ playPause(); setTimeout(()=>stopPlay(), 9000); }, 700);
    });

    // initial render
    updateAll({skipMap:true});

    /*****************************************************************
     * Storytelling texts (simple mapping)
     *****************************************************************/
    function getStoryText(dataset, year, region){
      // a few conditions to create nice captions
      if(dataset === 'vegetation'){
        if(year <= 2005) return 'سنة ٢٠٠٠–٢٠٠٥: غطاء نباتي قوي في المناطق الرئيسية.';
        if(year <= 2012) return 'سنة ٢٠٠٦–٢٠١٢: بداية تراجع واضح بسبب إزالة الغابات.';
        if(year <= 2018) return 'سنة ٢٠١3–٢٠١٨: فقدان متسارع في مناطق الأمازون ومناطق استوائية أخرى.';
        return 'سنة ٢٠١٩–٢٠٢٣: خسائر كبيرة في الغطاء النباتي — ضرورة إجراءات عاجلة.';
      } else if(dataset === 'ice'){
        if(year <= 2005) return 'جليد مستقر نسبياً، لكن علامات الذوبان بدأت تظهر.';
        if(year <= 2012) return 'ذوبان متسارع في الصيفات القطبية.';
        if(year <= 2018) return 'تراجع كبير في سمك الجليد البحري وموسمية الذوبان.';
        return 'الوصول إلى معدلات ذوبان غير مسبوقة في السجلات الحديثة.';
      } else {
        if(year <= 2005) return 'مستويات تلوث متوسطة في المدن الكبرى.';
        if(year <= 2012) return 'تزايد الانبعاثات نتيجة النمو الصناعي.';
        if(year <= 2018) return 'تحسن مؤقت في بعض المناطق (سياسات)، وتدهور في مناطق أخرى.';
        return 'عودة التلوث إلى مستويات مرتفعة بعد التعافي المؤقت.';
      }
    }

    /*****************************************************************
     * Quiz logic (3 questions)
     *****************************************************************/
    const QUIZ = [
      {
        q: 'كم نسبة فقدان الغطاء النباتي النموذجي بين 2000 و2020؟',
        choices: ['حوالي 10%','حوالي 30%','حوالي 50%'],
        answer: 1,
        explain: 'في المثال النموذجي أعطينا تراجع ملحوظ — اخترنا ~30% كمثال توضيحي.'
      },
      {
        q: 'أي طبقة تمثل الجليد في واجهة المستخدم؟',
        choices: ['vegetation','ice','pollution'],
        answer: 1,
        explain: 'الطبقة "ice" تمثل الغطاء الجليدي.'
      },
      {
        q: 'ماذا يفعل السلايدر الزمني؟',
        choices: ['يغير السنة ويحدّث الخريطة والـViewer','يغير الألوان فقط','يعدّل حجم الخريطة'],
        answer: 0,
        explain: 'السلايدر يتحكم في السنة ويُحدث الخريطة، الأنيميشن، والنصوص.'
      }
    ];

    let qIndex = 0;
    const qTitle = document.getElementById('qTitle');
    const choicesEl = document.getElementById('choices');
    const qFeedback = document.getElementById('qFeedback');
    const nextQ = document.getElementById('nextQ');
    const resetQ = document.getElementById('resetQ');

    function renderQuestion(){
      const q = QUIZ[qIndex];
      qTitle.textContent = q.q;
      choicesEl.innerHTML = '';
      q.choices.forEach((c,i) => {
        const btn = document.createElement('div');
        btn.className = 'choice';
        btn.textContent = c;
        btn.addEventListener('click', ()=> selectChoice(i, btn));
        choicesEl.appendChild(btn);
      });
      qFeedback.textContent = '';
    }
    function selectChoice(i, el){
      // prevent re-answering
      if(el.classList.contains('correct') || el.classList.contains('wrong')) return;
      const q = QUIZ[qIndex];
      if(i === q.answer){
        el.classList.add('correct');
        qFeedback.textContent = 'أحسنت! ' + q.explain;
      } else {
        el.classList.add('wrong');
        qFeedback.textContent = 'خطأ — ' + q.explain;
        // highlight correct
        const all = choicesEl.querySelectorAll('.choice');
        all[q.answer].classList.add('correct');
      }
    }
    nextQ.addEventListener('click', ()=> {
      qIndex++;
      if(qIndex >= QUIZ.length) qIndex = 0;
      renderQuestion();
    });
    resetQ.addEventListener('click', ()=> {
      qIndex = 0; renderQuestion();
    });
    renderQuestion();

    /*****************************************************************
     * Extra: small polish - animate elements on load
     *****************************************************************/
    gsap.from('header',{duration:.9,y:-20,opacity:0});
    gsap.from('.hero-card',{duration:1, x:-40, opacity:0, delay:0.1});
    gsap.from('.preview',{duration:1,x:40, opacity:0, delay:0.2});
    gsap.from('.panel',{duration:1, y:20, opacity:0, stagger:0.08, delay:0.4});
  </script>
</body>
</html>

